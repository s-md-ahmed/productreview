<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üõçÔ∏è Product Review App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: url('https://images.unsplash.com/photo-1607082350928-67bdf4f781d7?auto=format&fit=crop&w=1600&q=80') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Segoe UI', sans-serif;
      position: relative;
      min-height: 100vh;
    }
    body::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(4px);
      z-index: 0;
    }
    .container {
      position: relative;
      z-index: 1;
    }
    h1 {
      color: #ffffff;
      text-shadow: 1px 1px 4px rgba(0,0,0,0.5);
    }
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      transition: transform 0.2s ease;
    }
    .card:hover {
      transform: scale(1.01);
    }
    .card h5 {
      color: #0d6efd;
    }
    .btn-primary, .btn-success, .btn-outline-danger, .btn-outline-warning, .btn-outline-info {
      border-radius: 50px;
    }
    input, textarea {
      border-radius: 12px;
    }
    .section-title {
      color: #f8f9fa;
      font-weight: 600;
      margin-bottom: 0.8rem;
    }
    .edit-box {
      background-color: #f0f0f0;
      border-left: 4px solid #0d6efd;
      padding: 10px;
      border-radius: 10px;
    }
    #toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #198754;
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
      z-index: 9999;
      font-weight: 500;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h1 class="mb-4 text-center">üõçÔ∏è Product Review Portal</h1>

    <!-- Add New Product -->
    <div class="card p-4 shadow-sm mb-4 border-start border-4 border-primary">
      <h4 class="mb-3 text-secondary">Add New Product</h4>
      <input id="productName" class="form-control mb-2" placeholder="Product Name" />
      <textarea id="productDescription" class="form-control mb-2" placeholder="Product Description"></textarea>
      <input id="imageUrl" class="form-control mb-2" placeholder="Paste Image URL (optional)" />
      <button class="btn btn-outline-secondary w-100 mb-2" onclick="autoDetectProductTitle()">üéØ Auto Detect Product Name</button>
      <button class="btn btn-primary w-100" onclick="addProduct()">‚ûï Add Product</button>
    </div>

    <!-- Product List -->
    <div id="productList" class="row"></div>
  </div>

  <!-- Toast Box -->
  <div id="toast"></div>

  <script>
const API = "http://localhost:5000/api/products";
let currentProducts = [];

document.addEventListener("DOMContentLoaded", async () => {
  await loadProducts();
});

function showToast(message, color = "#198754") {
  const toast = document.getElementById("toast");
  toast.innerText = message;
  toast.style.backgroundColor = color;
  toast.style.display = "block";
  setTimeout(() => {
    toast.style.display = "none";
  }, 3000);
}

async function autoDetectProductTitle() {
  document.getElementById("productName").value = "";
  document.getElementById("productDescription").value = "";

  const url = document.getElementById("imageUrl").value.trim();
  if (!url) return alert("Please paste an image URL or product page link first.");

  const isImage = url.match(/\.(jpg|jpeg|png|webp)$/i);

  if (isImage) {
    try {
      const res = await fetch(`https://image-caption-generator.vercel.app/api/caption?url=${encodeURIComponent(url)}`);
      const data = await res.json();
      const caption = data.caption?.trim();
      if (caption) {
        document.getElementById("productName").value = caption;
        showToast("üîç Guessed from image: " + caption);
      } else {
        fallbackFromURL(url);
      }
    } catch {
      fallbackFromURL(url);
    }
  } else {
    fallbackFromURL(url);
  }
}

function fallbackFromURL(url) {
  try {
    const u = new URL(url);
    const segments = u.pathname.split('/').filter(Boolean);
    let candidate = segments[segments.length - 2] || segments[segments.length - 1];
    let words = candidate.replace(/[-_]/g, ' ').split(' ');
    words = words.filter(w =>
      w.length > 2 &&
      !w.match(/^[A-Z0-9\-]{5,}$/) &&
      !w.match(/^\d{4,}$/)
    );
    const capitalized = words.map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    let domainBrand = u.hostname.replace('www.', '').split('.')[0];
    domainBrand = domainBrand.charAt(0).toUpperCase() + domainBrand.slice(1);
    const finalName = `${domainBrand} ${capitalized}`.trim();

    document.getElementById("productName").value = finalName;

    const detectedBrand = detectBrandFromPath(segments);
    if (detectedBrand) {
      document.getElementById("productDescription").value = `Brand: ${detectedBrand}`;
      showToast("üõçÔ∏è Guessed: " + finalName + ` | Brand: ${detectedBrand}`);
    } else {
      showToast("üõçÔ∏è Guessed: " + finalName);
    }
  } catch {
    showToast("‚ö†Ô∏è Invalid URL", "#dc3545");
  }
}

function detectBrandFromPath(segments) {
  const brands = ["head", "yonex", "wilson", "babolat", "nike", "adidas", "puma"];
  for (const seg of segments) {
    for (const brand of brands) {
      if (seg.toLowerCase().includes(brand)) return brand.charAt(0).toUpperCase() + brand.slice(1);
    }
  }
  return null;
}

async function loadProducts() {
  const res = await fetch(API);
  const data = await res.json();
  currentProducts = data.map(p => p.name.toLowerCase().trim());
  const list = document.getElementById("productList");
  list.innerHTML = "";

  data.forEach(product => {
    const reviews = product.reviews.map(r => `
      <li class="mb-2" id="review-${r._id}">
        <span class="badge bg-primary">${r.username}</span>
        <span class="badge bg-warning text-dark">‚≠ê${r.rating}</span>
        <span class="ms-1">${r.comment}</span>
        <button onclick="enableReviewEdit('${product._id}', '${r._id}')" class="btn btn-sm btn-outline-warning ms-2">‚úèÔ∏è</button>
        <button onclick="enableReviewPut('${product._id}', '${r._id}')" class="btn btn-sm btn-outline-info ms-1">üñãÔ∏è</button>
        <button onclick="deleteReview('${product._id}', '${r._id}')" class="btn btn-sm btn-outline-danger ms-1">üóëÔ∏è</button>
      </li>
      <div id="edit-review-${r._id}" style="display: none;" class="edit-box mt-2 mb-2">
        <input id="edit-rating-${r._id}" type="number" min="1" max="5" class="form-control mb-1" value="${r.rating}">
        <input id="edit-comment-${r._id}" class="form-control mb-1" value="${r.comment}">
        <div class="d-flex justify-content-end">
          <button onclick="saveReviewEdit('${product._id}', '${r._id}')" class="btn btn-success btn-sm me-2">üíæ PATCH</button>
          <button onclick="cancelReviewEdit('${r._id}')" class="btn btn-secondary btn-sm">‚ùå</button>
        </div>
      </div>
      <div id="put-review-${r._id}" style="display: none;" class="edit-box mt-2 mb-2 bg-light">
        <input id="put-username-${r._id}" class="form-control mb-1" value="${r.username}">
        <input id="put-rating-${r._id}" type="number" min="1" max="5" class="form-control mb-1" value="${r.rating}">
        <input id="put-comment-${r._id}" class="form-control mb-1" value="${r.comment}">
        <div class="d-flex justify-content-end">
          <button onclick="saveReviewPut('${product._id}', '${r._id}')" class="btn btn-info btn-sm me-2">üíæ PUT</button>
          <button onclick="cancelReviewPut('${r._id}')" class="btn btn-secondary btn-sm">‚ùå</button>
        </div>
      </div>
    `).join('');

    list.innerHTML += `
      <div class="col-md-6 mb-4">
        <div class="card p-3 shadow-sm border-start border-4 border-success">
          <h5>${product.name}</h5>
          <p class="text-muted">${product.description}</p>
          <ul class="list-unstyled">${reviews}</ul>
          <div>
            <input placeholder="Name" id="u${product._id}" class="form-control mb-1" />
            <input placeholder="Rating (1-5)" type="number" id="r${product._id}" class="form-control mb-1" />
            <input placeholder="Comment" id="c${product._id}" class="form-control mb-2" />
            <button onclick="addReview('${product._id}')" class="btn btn-success w-100 btn-sm">üí¨ Add Review</button>
          </div>
        </div>
      </div>
    `;
  });
}

async function addProduct() {
  const name = document.getElementById("productName").value.trim();
  const description = document.getElementById("productDescription").value.trim();
  if (!name || !description) return alert("Fill all fields");
  if (currentProducts.includes(name.toLowerCase())) {
    return showToast("‚ùå Product already exists!", "#dc3545");
  }
  await fetch(API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, description })
  });
  await loadProducts();
}

async function addReview(id) {
  const username = document.getElementById(`u${id}`).value.trim();
  const rating = +document.getElementById(`r${id}`).value;
  const comment = document.getElementById(`c${id}`).value.trim();
  if (!username || !rating || !comment) return alert("Fill all review fields");
  if (rating > 5) return alert("Rating cannot exceed 5");
  await fetch(`${API}/${id}/reviews`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, rating, comment })
  });
  await loadProducts();
}

function enableReviewEdit(productId, reviewId) {
  cancelReviewPut(reviewId);
  document.getElementById(`edit-review-${reviewId}`).style.display = "block";
}

function cancelReviewEdit(reviewId) {
  document.getElementById(`edit-review-${reviewId}`).style.display = "none";
}

function enableReviewPut(productId, reviewId) {
  cancelReviewEdit(reviewId);
  document.getElementById(`put-review-${reviewId}`).style.display = "block";
}

function cancelReviewPut(reviewId) {
  document.getElementById(`put-review-${reviewId}`).style.display = "none";
}

async function saveReviewEdit(productId, reviewId) {
  const rating = +document.getElementById(`edit-rating-${reviewId}`).value;
  const comment = document.getElementById(`edit-comment-${reviewId}`).value.trim();
  if (!rating || !comment) return alert("Fill all fields");
  if (rating > 5) return alert("Rating cannot exceed 5");
  await fetch(`${API}/${productId}/reviews/${reviewId}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ rating, comment })
  });
  await loadProducts();
}

async function saveReviewPut(productId, reviewId) {
  const username = document.getElementById(`put-username-${reviewId}`).value.trim();
  const rating = +document.getElementById(`put-rating-${reviewId}`).value;
  const comment = document.getElementById(`put-comment-${reviewId}`).value.trim();
  if (!username || !rating || !comment) return alert("Fill all fields");
  if (rating > 5) return alert("Rating cannot exceed 5");
  await fetch(`${API}/${productId}/reviews/${reviewId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, rating, comment })
  });
  await loadProducts();
}

async function deleteReview(productId, reviewId) {
  const ok = confirm("Are you sure you want to delete this review?");
  if (!ok) return;
  await fetch(`${API}/${productId}/reviews/${reviewId}`, { method: "DELETE" });
  document.getElementById(`review-${reviewId}`)?.remove();
}
</script>

</body>
</html>
